
name: Deploy to Azure Static Web Apps

on:
  push:
    branches: [ main ]
  pull_request:
    types: [ opened, synchronize, reopened ]

jobs:
  build_and_deploy:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      # ✅ Use a strict Node 24.x version (adjust if you prefer 24.1.0 / 24.2.0 etc.)
      # This avoids runners picking an older/newer incompatible patch.
      - name: Use Node.js 22.x (strict pin)
        uses: actions/setup-node@v4
        with:
          node-version: '22.20.0'          # <-- pin exactly; change to a specific 24.x you trust
          cache: 'npm'                    # npm cache at ~/.npm

      # ✅ Restore node_modules cache (keyed by OS + Node + lockfile)
      - name: Restore node_modules cache
        id: node-modules-cache
        uses: actions/cache@v3
        with:
          path: |
            node_modules
          key: ${{ runner.os }}-node-${{ steps.setup-node.outputs.node-version }}-modules-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-${{ steps.setup-node.outputs.node-version }}-modules-
            ${{ runner.os }}-node-

      # (Optional but helpful) print versions to logs
      - name: Print tool versions
        run: |
          node -v
          npm -v
          npx ng version || true

      # ✅ Install deps; if cache hit restored node_modules, npm will verify & reuse
      - name: Install deps
        run: |
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm install
          fi

      # ✅ Save node_modules after install (if not restored)
      - name: Save node_modules cache
        if: steps.node-modules-cache.outputs.cache-hit != 'true'
        uses: actions/cache@v3
        with:
          path: |
            node_modules
          key: ${{ runner.os }}-node-${{ steps.setup-node.outputs.node-version }}-modules-${{ hashFiles('**/package-lock.json') }}

      # Build Angular (uses local CLI from node_modules/.bin)
      - name: Build Angular
        run: |
          npm run build -- --configuration production
          ls -la dist/IPA-Ai-Agents_UI/browser || (echo "Build output not found"; exit 1)

      # Deploy to Azure Static Web Apps
      - name: Build & Deploy
        uses: Azure/static-web-apps-deploy@v1
        env:
          NODE_VERSION: '22.20.0'
        with:
          action: "upload"
          azure_static_web_apps_api_token: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN_ZEALOUS_FIELD_0BD7C730F }}
          app_location: "/"
          output_location: "dist/IPA-Ai-Agents_UI/browser"
          skip_api_build: true

  close_preview:
    if: github.event_name == 'pull_request' && github.event.action == 'closed'
    runs-on: ubuntu-latest
    steps:
      - name: Close Preview Environment
        uses: Azure/static-web-apps-deploy@v1
        with:
          action: "close"
          azure_static_web_apps_api_token: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN_ZEALOUS_FIELD_0BD7C730F }}
          app_location: "/"
