
name: Deploy to Azure Static Web Apps

on:
  push:
    branches: [ main ]
  pull_request:
    types: [ opened, synchronize, reopened, closed ]

jobs:
  build_and_deploy:
    if: github.event_name == 'push' || (github.event_name == 'pull_request' && github.event.action != 'closed')
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      # Oryx will build inside the SWA action. We do NOT build locally here.
      # We tell Oryx which Node version to use and the Angular build command.
      # We also add a POST_BUILD_COMMAND to debug the artifact paths (runs inside the Oryx container).
      - name: Build & Deploy (Oryx builds Angular, then deploys)
        uses: Azure/static-web-apps-deploy@v1
        env:
          # ðŸ‘‰ Force Oryx to use a supported Node version for Angular 20/21
          NODE_VERSION: '22.20.0'
          # ðŸ‘‰ Turn on Angular's persistent build cache in the action environment
          NG_BUILD_CACHE: 'enabled'
          # ðŸ‘‰ Run debug commands inside Oryx AFTER the build (before deploy/validation)
          #    This helps confirm the exact place where index.html is written.
          POST_BUILD_COMMAND: |
            echo "===== Oryx build debug: listing dist ====="
            ls -la dist/IPA-Ai-Agents_UI || true
            ls -la dist/IPA-Ai-Agents_UI/browser || true
            echo "===== Oryx build debug: searching for index.html ====="
            find dist -maxdepth 4 -type f -name "index.html" -print || true
        with:
          action: "upload"
          azure_static_web_apps_api_token: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN_ZEALOUS_FIELD_0BD7C730F }}
          # Source code location (repo root)
          app_location: "/"
          # EXACT path to the Angular build output that contains index.html
          output_location: "dist/IPA-Ai-Agents_UI/browser"
          # Force the build command Oryx should run for the app
          app_build_command: "npm run build -- --configuration production"
          # No API in this project; keep this true if you don't have Functions
          skip_api_build: true

  close_preview:
    if: github.event_name == 'pull_request' && github.event.action == 'closed'
    runs-on: ubuntu-latest
    steps:
      - name: Close Preview Environment
        uses: Azure/static-web-apps-deploy@v1
        with:
          action: "close"
          azure_static_web_apps_api_token: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN_ZEALOUS_FIELD_0BD7C730F }}
          app_location: "/"
